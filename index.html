<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>נעם 1 - מעקב תדלוק לרכב</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .glass-effect {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }
        .btn-primary {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .image-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .alert {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        input[type="number"] {
            font-size: 18px;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .stats-card {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="p-4">
    <div class="max-w-6xl mx-auto">
        <!-- כותרת -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-white mb-2">
                <i class="fas fa-gas-pump text-yellow-300"></i>
                נעם 1 - מעקב תדלוק
            </h1>
            <p class="text-lg text-gray-200">מעקב פשוט ויעיל לצריכת דלק</p>
        </div>

        <!-- הודעות -->
        <div id="messages"></div>

        <!-- תיבת הוספת תדלוק -->
        <div class="glass-effect rounded-xl p-6 mb-8">
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">
                <i class="fas fa-plus-circle text-green-500"></i>
                הוספת תדלוק חדש
            </h2>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- צילום ספידומטר -->
                <div class="text-center">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">
                        <i class="fas fa-camera text-blue-500"></i>
                        צלמו ספידומטר
                    </h3>
                    <input type="file" id="speedometerImage" accept="image/*" capture="environment" class="hidden">
                    <button onclick="document.getElementById('speedometerImage').click()" class="btn-primary text-white px-6 py-3 rounded-lg font-bold text-lg w-full mb-3">
                        <i class="fas fa-camera"></i> צלמו ספידומטר
                    </button>
                    <div id="speedometerPreview" class="mt-3"></div>
                </div>

                <!-- צילום משאבת דלק -->
                <div class="text-center">
                    <h3 class="text-lg font-semibold mb-3 text-gray-700">
                        <i class="fas fa-camera text-red-500"></i>
                        צלמו משאבת דלק
                    </h3>
                    <input type="file" id="pumpImage" accept="image/*" capture="environment" class="hidden">
                    <button onclick="document.getElementById('pumpImage').click()" class="btn-primary text-white px-6 py-3 rounded-lg font-bold text-lg w-full mb-3">
                        <i class="fas fa-camera"></i> צלמו משאבת דלק
                    </button>
                    <div id="pumpPreview" class="mt-3"></div>
                </div>
            </div>

            <!-- הקלדת נתונים -->
            <div class="mt-6 bg-white rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-4 text-gray-700 text-center">
                    <i class="fas fa-keyboard text-purple-500"></i>
                    הקלידו 3 מספרים
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="text-center">
                        <label class="block text-sm font-medium text-gray-600 mb-2">ספידומטר (ק"מ)</label>
                        <input type="number" id="kilometers" placeholder="למשל: 125000" class="w-full">
                    </div>
                    <div class="text-center">
                        <label class="block text-sm font-medium text-gray-600 mb-2">ליטרים</label>
                        <input type="number" step="0.01" id="liters" placeholder="למשל: 45.5" class="w-full">
                    </div>
                    <div class="text-center">
                        <label class="block text-sm font-medium text-gray-600 mb-2">מחיר תדלוק (₪)</label>
                        <input type="number" step="0.01" id="totalPrice" placeholder="למשל: 275.50" class="w-full">
                    </div>
                </div>
            </div>

            <!-- כפתור שמירה -->
            <div class="text-center mt-6">
                <button onclick="saveFuelEntry()" class="btn-primary text-white px-8 py-4 rounded-lg font-bold text-xl">
                    <i class="fas fa-save"></i> שמור תדלוק
                </button>
            </div>
        </div>

        <!-- סטטיסטיקות -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
            <div class="stats-card">
                <div class="text-2xl font-bold" id="avgConsumption">0</div>
                <div class="text-sm">ק"מ לליטר</div>
            </div>
            <div class="stats-card">
                <div class="text-2xl font-bold" id="avgPricePerLiter">0</div>
                <div class="text-sm">₪ לליטר</div>
            </div>
            <div class="stats-card">
                <div class="text-2xl font-bold" id="monthlyEstimate">0</div>
                <div class="text-sm">₪ לחודש</div>
            </div>
            <div class="stats-card">
                <div class="text-2xl font-bold" id="avgDistance">0</div>
                <div class="text-sm">ק"מ בין תדלוקים</div>
            </div>
        </div>

        <!-- גרף צריכת דלק -->
        <div class="glass-effect rounded-xl p-6 mb-8">
            <h2 class="text-xl font-bold text-center mb-4 text-gray-800">
                <i class="fas fa-chart-line text-blue-500"></i>
                גרף צריכת דלק
            </h2>
            <div style="height: 400px;">
                <canvas id="fuelChart"></canvas>
            </div>
        </div>

        <!-- טבלת תדלוקים -->
        <div class="glass-effect rounded-xl p-6">
            <h2 class="text-xl font-bold text-center mb-4 text-gray-800">
                <i class="fas fa-table text-green-500"></i>
                היסטוריית תדלוקים
            </h2>
            <div class="table-container">
                <table class="w-full bg-white rounded-lg overflow-hidden">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-600">תאריך</th>
                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-600">ק"מ</th>
                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-600">מרחק</th>
                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-600">ליטרים</th>
                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-600">מחיר כולל</th>
                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-600">₪ לליטר</th>
                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-600">ק"מ/ליטר</th>
                            <th class="px-4 py-3 text-right text-sm font-medium text-gray-600">פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="fuelTableBody">
                        <!-- תדלוקים יופיעו כאן -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let fuelData = [];
        let fuelChart;
        let speedometerImageData = null;
        let pumpImageData = null;

        // טעינת נתונים בעת הפעלת האפליקציה
        window.onload = function() {
            loadFuelData();
            initChart();
        };

        // מנגנון שמירה מחוזק
        function saveToStorage(key, data) {
            try {
                const dataString = JSON.stringify(data);
                
                // נסיון 1: localStorage רגיל
                localStorage.setItem(key, dataString);
                
                // נסיון 2: גיבוי בsessionStorage
                sessionStorage.setItem(key + '_backup', dataString);
                
                // נסיון 3: גיבוי בקוקיס (למקרה הצורך)
                document.cookie = `${key}=${encodeURIComponent(dataString)}; path=/; expires=Fri, 31 Dec 2025 23:59:59 GMT`;
                
                return true;
            } catch (error) {
                console.error('שגיאה בשמירה:', error);
                return false;
            }
        }

        function loadFromStorage(key) {
            try {
                // נסיון 1: localStorage רגיל
                let data = localStorage.getItem(key);
                if (data) {
                    return JSON.parse(data);
                }
                
                // נסיון 2: גיבוי מsessionStorage
                data = sessionStorage.getItem(key + '_backup');
                if (data) {
                    return JSON.parse(data);
                }
                
                // נסיון 3: גיבוי מקוקיס
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [cookieName, cookieValue] = cookie.trim().split('=');
                    if (cookieName === key) {
                        return JSON.parse(decodeURIComponent(cookieValue));
                    }
                }
                
                return [];
            } catch (error) {
                console.error('שגיאה בטעינה:', error);
                return [];
            }
        }

        function loadFuelData() {
            fuelData = loadFromStorage('fuelData');
            updateTable();
            updateStats();
            updateChart();
        }

        function showMessage(message, type = 'success') {
            const messagesDiv = document.getElementById('messages');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            messagesDiv.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
            
            setTimeout(() => {
                messagesDiv.innerHTML = '';
            }, 3000);
        }

        // טיפול בתמונות
        document.getElementById('speedometerImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    speedometerImageData = event.target.result;
                    document.getElementById('speedometerPreview').innerHTML = 
                        `<img src="${speedometerImageData}" alt="ספידומטר" class="image-preview mx-auto">`;
                };
                reader.readAsDataURL(file);
            }
        });

        document.getElementById('pumpImage').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    pumpImageData = event.target.result;
                    document.getElementById('pumpPreview').innerHTML = 
                        `<img src="${pumpImageData}" alt="משאבת דלק" class="image-preview mx-auto">`;
                };
                reader.readAsDataURL(file);
            }
        });

        function saveFuelEntry() {
            const kilometers = parseFloat(document.getElementById('kilometers').value);
            const liters = parseFloat(document.getElementById('liters').value);
            const totalPrice = parseFloat(document.getElementById('totalPrice').value);

            // בדיקת נתונים
            if (!kilometers || !liters || !totalPrice) {
                showMessage('אנא מלאו את כל השדות', 'error');
                return;
            }

            if (kilometers <= 0 || liters <= 0 || totalPrice <= 0) {
                showMessage('אנא הכניסו מספרים חיוביים', 'error');
                return;
            }

            // חישוב נתונים
            const date = new Date().toLocaleDateString('he-IL');
            const pricePerLiter = (totalPrice / liters).toFixed(2);
            
            let distance = 0;
            let consumptionPerLiter = 0;
            
            if (fuelData.length > 0) {
                const lastEntry = fuelData[fuelData.length - 1];
                distance = kilometers - lastEntry.kilometers;
                if (distance > 0) {
                    consumptionPerLiter = (distance / liters).toFixed(2);
                }
            }

            const fuelEntry = {
                id: Date.now(),
                date: date,
                kilometers: kilometers,
                distance: distance,
                liters: liters,
                totalPrice: totalPrice,
                pricePerLiter: parseFloat(pricePerLiter),
                consumptionPerLiter: parseFloat(consumptionPerLiter),
                speedometerImage: speedometerImageData,
                pumpImage: pumpImageData
            };

            fuelData.push(fuelEntry);

            // שמירה מחוזקת
            if (saveToStorage('fuelData', fuelData)) {
                showMessage('התדלוק נשמר בהצלחה!', 'success');
                
                // איפוס הטופס
                document.getElementById('kilometers').value = '';
                document.getElementById('liters').value = '';
                document.getElementById('totalPrice').value = '';
                document.getElementById('speedometerPreview').innerHTML = '';
                document.getElementById('pumpPreview').innerHTML = '';
                speedometerImageData = null;
                pumpImageData = null;
                
                // עדכון התצוגה
                updateTable();
                updateStats();
                updateChart();
            } else {
                showMessage('שגיאה בשמירת הנתונים - אנא נסו שוב', 'error');
            }
        }

        function updateTable() {
            const tbody = document.getElementById('fuelTableBody');
            tbody.innerHTML = '';

            fuelData.forEach(entry => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm text-gray-900">${entry.date}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${entry.kilometers.toLocaleString()}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${entry.distance > 0 ? entry.distance.toLocaleString() : '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${entry.liters}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">₪${entry.totalPrice}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">₪${entry.pricePerLiter}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${entry.consumptionPerLiter > 0 ? entry.consumptionPerLiter : '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="viewImages(${entry.id})" class="text-blue-600 hover:text-blue-900 mr-2">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button onclick="deleteEntry(${entry.id})" class="text-red-600 hover:text-red-900">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
            });
        }

        function updateStats() {
            if (fuelData.length === 0) return;

            const validEntries = fuelData.filter(entry => entry.consumptionPerLiter > 0);
            
            // ממוצע צריכת דלק
            const avgConsumption = validEntries.length > 0 ? 
                (validEntries.reduce((sum, entry) => sum + entry.consumptionPerLiter, 0) / validEntries.length).toFixed(1) : 0;
            
            // ממוצע מחיר לליטר
            const avgPricePerLiter = (fuelData.reduce((sum, entry) => sum + entry.pricePerLiter, 0) / fuelData.length).toFixed(2);
            
            // ממוצע מרחק בין תדלוקים
            const avgDistance = validEntries.length > 0 ? 
                (validEntries.reduce((sum, entry) => sum + entry.distance, 0) / validEntries.length).toFixed(0) : 0;
            
            // הערכה חודשית (בהנחה של 1500 ק"מ לחודש)
            const monthlyEstimate = avgConsumption > 0 ? 
                ((1500 / avgConsumption) * avgPricePerLiter).toFixed(0) : 0;

            document.getElementById('avgConsumption').textContent = avgConsumption;
            document.getElementById('avgPricePerLiter').textContent = avgPricePerLiter;
            document.getElementById('monthlyEstimate').textContent = monthlyEstimate;
            document.getElementById('avgDistance').textContent = avgDistance;
        }

        function initChart() {
            const ctx = document.getElementById('fuelChart').getContext('2d');
            fuelChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'צריכת דלק (ק"מ לליטר)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1
                    }, {
                        label: 'מחיר לליטר (₪)',
                        data: [],
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        yAxisID: 'y1'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: 14
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        function updateChart() {
            if (!fuelChart) return;

            const validEntries = fuelData.filter(entry => entry.consumptionPerLiter > 0);
            
            fuelChart.data.labels = validEntries.map(entry => entry.date);
            fuelChart.data.datasets[0].data = validEntries.map(entry => entry.consumptionPerLiter);
            fuelChart.data.datasets[1].data = validEntries.map(entry => entry.pricePerLiter);
            fuelChart.update();
        }

        function viewImages(id) {
            const entry = fuelData.find(item => item.id === id);
            if (entry) {
                let imagesHtml = '<div style="text-align: center;">';
                
                if (entry.speedometerImage) {
                    imagesHtml += `<div style="margin: 20px;"><h3>ספידומטר</h3><img src="${entry.speedometerImage}" style="max-width: 300px; max-height: 300px; border-radius: 10px;"></div>`;
                }
                
                if (entry.pumpImage) {
                    imagesHtml += `<div style="margin: 20px;"><h3>משאבת דלק</h3><img src="${entry.pumpImage}" style="max-width: 300px; max-height: 300px; border-radius: 10px;"></div>`;
                }
                
                imagesHtml += '</div>';
                
                const newWindow = window.open('', '_blank', 'width=800,height=600');
                newWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl">
                    <head>
                        <title>תמונות תדלוק - ${entry.date}</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            h3 { color: #333; margin-bottom: 10px; }
                        </style>
                    </head>
                    <body>
                        <h2>תמונות תדלוק - ${entry.date}</h2>
                        ${imagesHtml}
                        <button onclick="window.close()" style="padding: 10px 20px; background: #007cba; color: white; border: none; border-radius: 5px; cursor: pointer;">סגור</button>
                    </body>
                    </html>
                `);
            }
        }

        function deleteEntry(id) {
            if (confirm('האם אתם בטוחים שברצונכם למחוק את התדלוק?')) {
                fuelData = fuelData.filter(entry => entry.id !== id);
                if (saveToStorage('fuelData', fuelData)) {
                    showMessage('התדלוק נמחק בהצלחה', 'success');
                    updateTable();
                    updateStats();
                    updateChart();
                } else {
                    showMessage('שגיאה במחיקת הנתונים', 'error');
                }
            }
        }
    </script>
</body>
</html>
