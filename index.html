<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>נעם 1 - מעקב תדלוק לרכב</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .main-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 15px;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .btn-success {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            margin-bottom: 15px;
            text-align: center;
        }
        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        .photo-preview {
            width: 100%;
            max-width: 200px;
            height: 150px;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 10px auto;
            background: #f8f9fa;
        }
        .photo-preview img {
            max-width: 100%;
            max-height: 100%;
            border-radius: 8px;
        }
        .history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .history-table th,
        .history-table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: center;
        }
        .history-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .history-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .message {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .hidden {
            display: none;
        }
        .stats-card {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            text-align: center;
        }
        .stats-number {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stats-label {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Header -->
        <div class="card">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">
                <i class="fas fa-gas-pump text-blue-500"></i>
                נעם 1 - מעקב תדלוק לרכב
            </h1>
            <p class="text-center text-gray-600 mb-4">
                אפליקציה פשוטה לכל המשפחה - צלמו, הקלידו 3 מספרים והכל יחושב אוטומטית!
            </p>
        </div>

        <!-- Photo Section -->
        <div class="card">
            <h2 class="text-xl font-bold text-center mb-4">
                <i class="fas fa-camera text-blue-500"></i>
                צילום תמונות
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Speedometer Photo -->
                <div class="text-center">
                    <h3 class="font-bold mb-2">1. צלמו ספידומטר</h3>
                    <div class="photo-preview" id="speedometerPreview">
                        <i class="fas fa-tachometer-alt text-gray-400 text-4xl"></i>
                    </div>
                    <button class="btn-primary" onclick="takeSpeedometerPhoto()">
                        <i class="fas fa-camera"></i> צלמו ספידומטר
                    </button>
                </div>

                <!-- Fuel Pump Photo -->
                <div class="text-center">
                    <h3 class="font-bold mb-2">2. צלמו משאבת דלק</h3>
                    <div class="photo-preview" id="pumpPreview">
                        <i class="fas fa-gas-pump text-gray-400 text-4xl"></i>
                    </div>
                    <button class="btn-primary" onclick="takePumpPhoto()">
                        <i class="fas fa-camera"></i> צלמו משאבת דלק
                    </button>
                </div>
            </div>
        </div>

        <!-- Input Section -->
        <div class="card">
            <h2 class="text-xl font-bold text-center mb-4">
                <i class="fas fa-keyboard text-green-500"></i>
                הקלידו 3 מספרים
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block font-bold mb-2">ספידומטר (ק"מ)</label>
                    <input type="number" id="kilometers" class="input-field" placeholder="מספר הק״מ">
                </div>
                <div>
                    <label class="block font-bold mb-2">ליטרים</label>
                    <input type="number" step="0.01" id="liters" class="input-field" placeholder="כמות ליטרים">
                </div>
                <div>
                    <label class="block font-bold mb-2">מחיר תדלוק (₪)</label>
                    <input type="number" step="0.01" id="totalPrice" class="input-field" placeholder="מחיר כולל">
                </div>
            </div>

            <button class="btn-success" onclick="saveFuelRecord()">
                <i class="fas fa-save"></i> שמור תדלוק
            </button>
        </div>

        <!-- Messages -->
        <div id="messageContainer"></div>

        <!-- Statistics -->
        <div class="card">
            <h2 class="text-xl font-bold text-center mb-4">
                <i class="fas fa-chart-line text-purple-500"></i>
                סטטיסטיקות
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="statsContainer">
                <div class="stats-card">
                    <div class="stats-number" id="avgConsumption">-</div>
                    <div class="stats-label">ממוצע צריכה (ק״מ לליטר)</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="avgCost">-</div>
                    <div class="stats-label">עלות חודשית משוערת (₪)</div>
                </div>
                <div class="stats-card">
                    <div class="stats-number" id="avgDistance">-</div>
                    <div class="stats-label">מרחק ממוצע בין תדלוקים (ק״מ)</div>
                </div>
            </div>
        </div>

        <!-- History Table -->
        <div class="card">
            <h2 class="text-xl font-bold text-center mb-4">
                <i class="fas fa-history text-orange-500"></i>
                היסטוריית תדלוקים
            </h2>
            
            <div class="overflow-x-auto">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>תאריך</th>
                            <th>ק"מ נוכחי</th>
                            <th>מרחק נסיעה</th>
                            <th>ליטרים</th>
                            <th>מחיר כולל</th>
                            <th>מחיר לליטר</th>
                            <th>ק"מ לליטר</th>
                            <th>פעולות</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <tr>
                            <td colspan="8" class="text-center text-gray-500">אין תדלוקים עדיין</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Hidden File Inputs -->
    <input type="file" id="speedometerInput" accept="image/*" capture="environment" style="display: none;" onchange="handleSpeedometerPhoto(event)">
    <input type="file" id="pumpInput" accept="image/*" capture="environment" style="display: none;" onchange="handlePumpPhoto(event)">

    <script>
        // Global variables
        let speedometerPhoto = null;
        let pumpPhoto = null;
        let fuelRecords = [];

        // Load data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadFuelRecords();
            displayHistory();
            updateStatistics();
        });

        // Photo functions
        function takeSpeedometerPhoto() {
            document.getElementById('speedometerInput').click();
        }

        function takePumpPhoto() {
            document.getElementById('pumpInput').click();
        }

        function handleSpeedometerPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    speedometerPhoto = e.target.result;
                    document.getElementById('speedometerPreview').innerHTML = 
                        `<img src="${speedometerPhoto}" alt="ספידומטר">`;
                };
                reader.readAsDataURL(file);
            }
        }

        function handlePumpPhoto(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    pumpPhoto = e.target.result;
                    document.getElementById('pumpPreview').innerHTML = 
                        `<img src="${pumpPhoto}" alt="משאבת דלק">`;
                };
                reader.readAsDataURL(file);
            }
        }

        // Save fuel record
        function saveFuelRecord() {
            try {
                const kilometers = parseFloat(document.getElementById('kilometers').value);
                const liters = parseFloat(document.getElementById('liters').value);
                const totalPrice = parseFloat(document.getElementById('totalPrice').value);

                // Validation
                if (!kilometers || !liters || !totalPrice) {
                    showMessage('נא למלא את כל השדות', 'error');
                    return;
                }

                if (kilometers <= 0 || liters <= 0 || totalPrice <= 0) {
                    showMessage('כל הערכים חייבים להיות חיוביים', 'error');
                    return;
                }

                // Calculate values
                const pricePerLiter = totalPrice / liters;
                const previousRecord = fuelRecords.length > 0 ? fuelRecords[fuelRecords.length - 1] : null;
                const distance = previousRecord ? kilometers - previousRecord.kilometers : 0;
                const consumptionRate = distance > 0 ? distance / liters : 0;

                // Create record
                const record = {
                    id: Date.now(),
                    date: new Date().toLocaleDateString('he-IL'),
                    kilometers: kilometers,
                    liters: liters,
                    totalPrice: totalPrice,
                    pricePerLiter: pricePerLiter,
                    distance: distance,
                    consumptionRate: consumptionRate,
                    speedometerPhoto: speedometerPhoto,
                    pumpPhoto: pumpPhoto
                };

                // Add to records
                fuelRecords.push(record);

                // Save to localStorage
                saveFuelRecords();

                // Update display
                displayHistory();
                updateStatistics();

                // Clear form
                clearForm();

                showMessage('התדלוק נשמר בהצלחה!', 'success');
            } catch (error) {
                console.error('שגיאה בשמירת תדלוק:', error);
                showMessage('שגיאה בשמירת התדלוק. אנא נסו שוב.', 'error');
            }
        }

        // Clear form
        function clearForm() {
            document.getElementById('kilometers').value = '';
            document.getElementById('liters').value = '';
            document.getElementById('totalPrice').value = '';
            
            document.getElementById('speedometerPreview').innerHTML = 
                '<i class="fas fa-tachometer-alt text-gray-400 text-4xl"></i>';
            document.getElementById('pumpPreview').innerHTML = 
                '<i class="fas fa-gas-pump text-gray-400 text-4xl"></i>';
            
            speedometerPhoto = null;
            pumpPhoto = null;
        }

        // Display history
        function displayHistory() {
            const tbody = document.getElementById('historyTableBody');
            
            if (fuelRecords.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">אין תדלוקים עדיין</td></tr>';
                return;
            }

            tbody.innerHTML = fuelRecords.map(record => `
                <tr>
                    <td>${record.date}</td>
                    <td>${record.kilometers.toLocaleString()}</td>
                    <td>${record.distance > 0 ? record.distance.toLocaleString() : '-'}</td>
                    <td>${record.liters.toFixed(2)}</td>
                    <td>₪${record.totalPrice.toFixed(2)}</td>
                    <td>₪${record.pricePerLiter.toFixed(2)}</td>
                    <td>${record.consumptionRate > 0 ? record.consumptionRate.toFixed(2) : '-'}</td>
                    <td>
                        <button onclick="deleteRecord(${record.id})" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Update statistics
        function updateStatistics() {
            if (fuelRecords.length < 2) {
                document.getElementById('avgConsumption').textContent = '-';
                document.getElementById('avgCost').textContent = '-';
                document.getElementById('avgDistance').textContent = '-';
                return;
            }

            // Calculate averages
            const validRecords = fuelRecords.filter(r => r.consumptionRate > 0);
            const avgConsumption = validRecords.length > 0 ? 
                validRecords.reduce((sum, r) => sum + r.consumptionRate, 0) / validRecords.length : 0;

            const avgDistance = validRecords.length > 0 ? 
                validRecords.reduce((sum, r) => sum + r.distance, 0) / validRecords.length : 0;

            // Calculate monthly cost (assuming 30 days)
            const avgPricePerLiter = fuelRecords.reduce((sum, r) => sum + r.pricePerLiter, 0) / fuelRecords.length;
            const dailyConsumption = avgDistance > 0 ? avgDistance / 30 : 0;
            const dailyLiters = avgConsumption > 0 ? dailyConsumption / avgConsumption : 0;
            const monthlyCost = dailyLiters * avgPricePerLiter * 30;

            // Update display
            document.getElementById('avgConsumption').textContent = avgConsumption > 0 ? avgConsumption.toFixed(2) : '-';
            document.getElementById('avgCost').textContent = monthlyCost > 0 ? `₪${monthlyCost.toFixed(0)}` : '-';
            document.getElementById('avgDistance').textContent = avgDistance > 0 ? avgDistance.toFixed(0) : '-';
        }

        // Delete record
        function deleteRecord(id) {
            if (confirm('האם אתם בטוחים שברצונכם למחוק את התדלוק?')) {
                fuelRecords = fuelRecords.filter(record => record.id !== id);
                saveFuelRecords();
                displayHistory();
                updateStatistics();
                showMessage('התדלוק נמחק בהצלחה', 'success');
            }
        }

        // Save to localStorage
        function saveFuelRecords() {
            try {
                localStorage.setItem('fuelRecords', JSON.stringify(fuelRecords));
                console.log('נתונים נשמרו בהצלחה:', fuelRecords.length, 'רשומות');
            } catch (error) {
                console.error('שגיאה בשמירת נתונים:', error);
                showMessage('שגיאה בשמירת הנתונים', 'error');
            }
        }

        // Load from localStorage
        function loadFuelRecords() {
            try {
                const saved = localStorage.getItem('fuelRecords');
                if (saved) {
                    fuelRecords = JSON.parse(saved);
                    console.log('נתונים נטענו בהצלחה:', fuelRecords.length, 'רשומות');
                } else {
                    fuelRecords = [];
                    console.log('אין נתונים שמורים');
                }
            } catch (error) {
                console.error('שגיאה בטעינת נתונים:', error);
                fuelRecords = [];
                showMessage('שגיאה בטעינת הנתונים השמורים', 'error');
            }
        }

        // Show message
        function showMessage(text, type) {
            const container = document.getElementById('messageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.textContent = text;
            
            container.innerHTML = '';
            container.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }
    </script>
</body>
</html>
